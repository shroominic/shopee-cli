# Shopee Web API Documentation

## Base URL

```
https://shopee.com.my/api/v4/
```

## Authentication Flow

1. User opens Chrome via Selenium to `https://shopee.com.my/buyer/login`
2. User manually logs in (SMS OTP, password, or QR code)
3. CLI captures all cookies from the browser session
4. Cookies are saved locally and replayed in subsequent HTTP requests
5. Key session cookie: `SPC_EC` (Shopee session token)

### Why Selenium?

Shopee uses aggressive anti-bot measures:

- **Device fingerprinting** via `af-ac-enc-dat` header (encrypted device/browser fingerprint)
- **Behavioral analysis** on login flows
- **CAPTCHAs** triggered by suspicious patterns
- **Encrypted request headers** that are generated client-side by obfuscated JavaScript

By letting the user log in manually in a real browser, we bypass all of these. We only need the resulting session cookies to make authenticated API requests.

## Known Endpoints

### Search

```
GET /api/v4/search/search_items
```

Parameters:

- `keyword` (str) - Search query
- `limit` (int) - Results per page (default: 60)
- `newest` (int) - Offset for pagination (default: 0)
- `order` (str) - Sort order: `desc`, `asc`
- `page_type` (str) - `search`
- `scenario` (str) - `PAGE_GLOBAL_SEARCH`
- `by` (str) - Sort by: `relevancy`, `ctime`, `sales`, `price`

Response: JSON with `items` array containing `item_basic` objects.

### Product Detail

```
GET /api/v4/pdp/get_pc
```

Parameters:

- `shop_id` (int) - Shop ID
- `item_id` (int) - Item/product ID

Response: JSON with full product details including models (variants), pricing, stock, ratings.

### Orders

```
GET /api/v4/order/get_all_order_and_checkout_list
```

Parameters (needs exploration):

- `limit` (int)
- `offset` (int)
- `list_type` (int) - Order status filter (0=all, 3=to ship, etc.)

Requires authentication.

### Cart (needs exploration)

```
POST /api/v4/cart/add_to_cart
POST /api/v4/checkout/get
POST /api/v4/checkout/place_order
```

These endpoints need further exploration via browser DevTools.

## Required Headers

```
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...
Referer: https://shopee.com.my/
X-Shopee-Language: en
X-CSRFToken: <from csrftoken cookie>
X-Requested-With: XMLHttpRequest
Content-Type: application/json
```

## Important Cookies

| Cookie | Purpose |
|--------|---------|
| `SPC_EC` | Main session token (authenticated session) |
| `SPC_F` | Device fingerprint ID |
| `SPC_SI` | Session identifier |
| `SPC_ST` | Session timestamp |
| `csrftoken` | CSRF protection token (also sent as X-CSRFToken header) |
| `shopee_token` | Auth token |

## Anti-Bot Measures

### `af-ac-enc-dat` Header

- Encrypted blob sent with most API requests
- Generated by obfuscated client-side JavaScript
- Contains device fingerprint, behavioral signals, timing data
- **Our approach**: Skip this header. Most read-only endpoints work without it when valid session cookies are provided. Write endpoints (checkout) may require it.

### Rate Limiting

- Shopee rate-limits aggressive request patterns
- Add reasonable delays between requests (1-3 seconds)
- Rotate User-Agent strings if needed

### Session Expiry

- Sessions typically expire after a few hours to days
- Monitor for 401/403 responses or `error` in response body
- Re-prompt user to login when session expires

## Response Format

Most endpoints return:

```json
{
    "error": 0,
    "error_msg": "",
    "data": { ... }
}
```

Error code `0` means success. Non-zero indicates an error.

## Useful Browser DevTools Tips

1. Open DevTools -> Network tab
2. Filter by `api/v4`
3. Browse Shopee normally to see API calls
4. Right-click request -> Copy as cURL for testing
5. Check response payloads for field names and structures
